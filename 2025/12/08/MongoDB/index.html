<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>MongoDB | Qué miras Bobo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="MongoDB 是一个基于文档的开源 NoSQL 数据库，使用类似 JSON 的文档模型灵活存储数据，旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。MongoDB 是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。 https:&#x2F;&#x2F;www.mongodb.com&#x2F;zh-cn&#x2F;docs&#x2F;manual&#x2F;cru">
<meta property="og:type" content="article">
<meta property="og:title" content="MongoDB">
<meta property="og:url" content="http://example.com/2025/12/08/MongoDB/index.html">
<meta property="og:site_name" content="Qué miras Bobo">
<meta property="og:description" content="MongoDB 是一个基于文档的开源 NoSQL 数据库，使用类似 JSON 的文档模型灵活存储数据，旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。MongoDB 是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。 https:&#x2F;&#x2F;www.mongodb.com&#x2F;zh-cn&#x2F;docs&#x2F;manual&#x2F;cru">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.thehotskills.com/wp-content/uploads/2019/07/mongodb-logo-png.png">
<meta property="article:published_time" content="2025-12-08T05:34:33.000Z">
<meta property="article:modified_time" content="2026-01-04T15:14:57.900Z">
<meta property="article:author" content="fengcai">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.thehotskills.com/wp-content/uploads/2019/07/mongodb-logo-png.png">
  
    <link rel="alternate" href="/atom.xml" title="Qué miras Bobo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="https://github.com/leo710aka/bk/blob/main/DT1.jpg?raw=true">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Qué miras Bobo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-MongoDB" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/12/08/MongoDB/" class="article-date">
  <time class="dt-published" datetime="2025-12-08T05:34:33.000Z" itemprop="datePublished">2025-12-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      MongoDB
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <br>
<div style="display: flex; align-items: center;">
  <div style="flex: 0 0 30%;">
    <img src="https://www.thehotskills.com/wp-content/uploads/2019/07/mongodb-logo-png.png" alt="" style="max-width: 100%;">
  </div>
  <div style="flex: 1; padding-left: 10px;">
    <p><em>MongoDB 是一个基于文档的开源 NoSQL 数据库，使用类似 JSON 的文档模型灵活存储数据，旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。<br>MongoDB 是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。<br> https://www.mongodb.com/zh-cn/docs/manual/crud/</em></p>
  </div>
</div>


<table>
<thead>
<tr>
<th align="left">MongoDB 概念</th>
<th align="left">类比 MySQL 概念</th>
<th align="left">类比 Elasticsearch 概念</th>
<th align="left">核心解析</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>文档 (Document)</strong></td>
<td align="left">行 (Row)</td>
<td align="left">文档 (Document)</td>
<td align="left"><strong>数据的基本单元</strong>，是一个键值对的有序集合。它类似于一条完整的记录。</td>
</tr>
<tr>
<td align="left"><strong>集合 (Collection)</strong></td>
<td align="left">表 (Table)</td>
<td align="left">索引 (Index)</td>
<td align="left"><strong>一组文档的容器</strong>。它类似于一张数据表。</td>
</tr>
<tr>
<td align="left"><strong>数据库 (Database)</strong></td>
<td align="left">数据库 (Database)</td>
<td align="left">无直接对应（可类比为索引的逻辑分组）</td>
<td align="left"><strong>最高层的命名空间</strong>，用于组织和管理多个集合。一个 MongoDB 实例可以运行多个数据库，每个数据库在文件系统上有独立的文件。</td>
</tr>
<tr>
<td align="left"><strong>字段 (Field)</strong></td>
<td align="left">列 (Column)</td>
<td align="left">字段 (Field)</td>
<td align="left"><strong>文档中的键值对</strong>，代表一个数据属性。</td>
</tr>
</tbody></table>
<ul>
<li>关键特性与对比<br><strong>1. BSON：MongoDB 的“增强版JSON”</strong><br>BSON（Binary JSON）是 MongoDB 用来存储文档和数据交换的二进制格式。您可以把它理解为 JSON 的超级版，它支持 JSON 的所有数据类型，但更强大：  <strong>二进制编码</strong>：比 JSON 更紧凑，存储和扫描效率更高。<strong>更丰富的数据类型</strong>：除了字符串、数字、数组、对象外，还支持<strong>日期、对象ID（ObjectId）、二进制数据</strong>等特定类型。<br><strong>2. 灵活的模式（Schema）</strong><br>这是 MongoDB 与 MySQL 最根本的区别之一。同一个集合内的文档不需要具有相同的字段集。您可以随时为文档添加新字段，而无需像关系型数据库那样进行复杂的 <code>ALTER TABLE</code> 操作。</li>
<li>如何根据场景选择<table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">MongoDB</th>
<th align="left">MySQL</th>
<th align="left">Elasticsearch</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>数据模型</strong></td>
<td align="left">文档模型，动态模式</td>
<td align="left">关系模型，固定模式</td>
<td align="left">文档模型，可定义映射</td>
</tr>
<tr>
<td align="left"><strong>查询语言</strong></td>
<td align="left">面向对象的 API 方法</td>
<td align="left">标准 SQL 语句</td>
<td align="left">JSON-based DSL</td>
</tr>
<tr>
<td align="left"><strong>核心优势</strong></td>
<td align="left">敏捷开发、水平扩展、存储复杂数据结构</td>
<td align="left">复杂查询、事务一致性、数据完整性</td>
<td align="left">全文搜索、日志分析、复杂聚合</td>
</tr>
<tr>
<td align="left"><strong>典型场景</strong></td>
<td align="left">内容管理系统、用户画像、实时分析、物联网</td>
<td align="left">金融交易系统、ERP、CRM等需要严格事务的系统</td>
<td align="left">搜索引擎、日志和指标分析、应用内搜索</td>
</tr>
</tbody></table>
</li>
<li>Mongo CRUD汇总<table>
<thead>
<tr>
<th align="left">操作类型</th>
<th align="left">方法示例</th>
<th align="left">功能说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>创建 (Create)</strong></td>
<td align="left"><code>db.hosts.insertOne(&#123;hostname: &quot;web-01&quot;, ip: &quot;192.168.1.100&quot;&#125;)</code></td>
<td align="left">向集合中插入一条新文档。若集合不存在，会自动创建。</td>
</tr>
<tr>
<td align="left"><strong>批量创建</strong></td>
<td align="left"><code>db.hosts.insertMany([&#123;hostname: &quot;web-01&quot;&#125;, &#123;hostname: &quot;db-01&quot;&#125;])</code></td>
<td align="left">批量插入多条文档。</td>
</tr>
<tr>
<td align="left"><strong>查询 (Read)</strong></td>
<td align="left"><code>db.hosts.find(&#123;status: &quot;running&quot;&#125;)</code></td>
<td align="left">查询所有符合条件的文档。不传参数则返回所有文档。</td>
</tr>
<tr>
<td align="left"><strong>条件查询</strong></td>
<td align="left"><code>db.hosts.find(&#123;&quot;specs.memory&quot;: &#123;$gte: 8&#125;&#125;, &#123;hostname: 1, _id: 0&#125;)</code></td>
<td align="left">使用查询操作符进行过滤，并使用投影选择返回的字段。</td>
</tr>
<tr>
<td align="left"><strong>更新 (Update)</strong></td>
<td align="left"><code>db.hosts.updateOne(&#123;hostname: &quot;web-01&quot;&#125;, &#123;$set: &#123;&quot;specs.memory&quot;: 32&#125;&#125;)</code></td>
<td align="left">更新一条匹配的文档。<code>$set</code> 操作符用于修改特定字段的值。</td>
</tr>
<tr>
<td align="left"><strong>批量更新</strong></td>
<td align="left"><code>db.hosts.updateMany(&#123;environment: &quot;production&quot;&#125;, &#123;$inc: &#123;visits: 1&#125;&#125;)</code></td>
<td align="left">更新所有匹配的文档。<code>$inc</code> 操作符用于将字段的值增加指定数额。</td>
</tr>
<tr>
<td align="left"><strong>删除 (Delete)</strong></td>
<td align="left"><code>db.hosts.deleteOne(&#123;hostname: &quot;web-01&quot;&#125;)</code></td>
<td align="left">删除一条匹配的文档。</td>
</tr>
<tr>
<td align="left"><strong>批量删除</strong></td>
<td align="left"><code>db.hosts.deleteMany(&#123;status: &quot;terminated&quot;&#125;)</code></td>
<td align="left">删除所有匹配的文档。</td>
</tr>
</tbody></table>
</li>
</ul>
<h3 id="读写"><a href="#读写" class="headerlink" title="读写"></a>读写</h3><ul>
<li>写入确认：默认情况下，MongoDB 的写入操作是异步的。如果你的应用需要确保数据已经安全写入，可以设置 <strong>写关注</strong>（Write Concern）来控制确认级别。</li>
<li>单文档原子性：所有 CRUD 操作在 <strong>单个文档</strong> 级别是原子的。例如，一条文档的更新操作要么完全成功，要么完全失败，不会出现只更新一半字段的情况。需要注意的是，<code>insertMany</code> 这样的多文档操作，默认情况下并非一个整体事务。</li>
<li>比较操作符：<code>$gt</code> (大于), <code>$gte</code> (大于等于), <code>$lt</code> (小于), <code>$lte</code> (小于等于), <code>$ne</code> (不等于)。<br>逻辑操作符：<code>$and</code>, <code>$or</code>, <code>$in</code> (匹配数组中任意值), <code>$nin</code> (不匹配数组中任何值)。</li>
<li>关键操作：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建</span></span><br><span class="line">db.<span class="property">hosts</span>.<span class="title function_">insertOne</span>(&#123;</span><br><span class="line">  <span class="attr">hostname</span>: <span class="string">&quot;web-01&quot;</span>, </span><br><span class="line">  <span class="attr">ip</span>: <span class="string">&quot;192.168.1.100&quot;</span>,</span><br><span class="line">  <span class="attr">specs</span>: &#123; <span class="attr">cpu</span>: <span class="number">8</span>, <span class="attr">memory</span>: <span class="number">16</span> &#125;, <span class="comment">// 嵌入式文档</span></span><br><span class="line">  <span class="attr">tags</span>: [<span class="string">&quot;web&quot;</span>, <span class="string">&quot;production&quot;</span>]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询与投影</span></span><br><span class="line">db.<span class="property">hosts</span>.<span class="title function_">find</span>(</span><br><span class="line">  &#123; <span class="string">&quot;specs.memory&quot;</span>: &#123; <span class="attr">$gte</span>: <span class="number">8</span> &#125;, <span class="string">&quot;status&quot;</span>: <span class="string">&quot;running&quot;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">hostname</span>: <span class="number">1</span>, <span class="attr">ip</span>: <span class="number">1</span>, <span class="attr">_id</span>: <span class="number">0</span> &#125; <span class="comment">// 投影：只返回指定字段</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新操作符</span></span><br><span class="line">db.<span class="property">hosts</span>.<span class="title function_">updateOne</span>(</span><br><span class="line">  &#123; <span class="attr">hostname</span>: <span class="string">&quot;web-01&quot;</span> &#125;,</span><br><span class="line">  &#123; </span><br><span class="line">    <span class="attr">$set</span>: &#123; <span class="string">&quot;specs.memory&quot;</span>: <span class="number">32</span> &#125;,	<span class="comment">// 设置字段</span></span><br><span class="line">    <span class="attr">$push</span>: &#123; <span class="attr">tags</span>: <span class="string">&quot;upgraded&quot;</span> &#125;,	<span class="comment">// 数组追加</span></span><br><span class="line">    <span class="attr">$inc</span>: &#123; <span class="string">&quot;stats.visits&quot;</span>: <span class="number">1</span> &#125;	<span class="comment">// 数值递增</span></span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
<li>复杂查询模式：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 逻辑组合查询</span></span><br><span class="line">db.<span class="property">hosts</span>.<span class="title function_">find</span>(&#123;</span><br><span class="line">  <span class="attr">$or</span>: [  <span class="comment">// $or逻辑操作符用于筛选出符合任意一组给定条件的文档</span></span><br><span class="line">    &#123; <span class="string">&quot;environment&quot;</span>: <span class="string">&quot;production&quot;</span>, <span class="string">&quot;status&quot;</span>: <span class="string">&quot;running&quot;</span> &#125;,  <span class="comment">// 每个条件组内部使用隐式的AND逻辑，需同时满足</span></span><br><span class="line">    &#123; <span class="string">&quot;criticality&quot;</span>: <span class="string">&quot;high&quot;</span>, <span class="string">&quot;last_backup&quot;</span>: &#123; <span class="attr">$gte</span>: yesterday &#125; &#125;  <span class="comment">// $gte是“大于或等于”的比较操作符</span></span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数组查询</span></span><br><span class="line">db.<span class="property">hosts</span>.<span class="title function_">find</span>(&#123;</span><br><span class="line">  <span class="string">&quot;tags&quot;</span>: &#123; <span class="attr">$all</span>: [<span class="string">&quot;web&quot;</span>, <span class="string">&quot;load_balancer&quot;</span>] &#125;, <span class="comment">// 包含所有指定标签</span></span><br><span class="line">  <span class="string">&quot;ips&quot;</span>: &#123; <span class="attr">$size</span>: <span class="number">3</span> &#125; <span class="comment">// 数组长度匹配</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正则表达式与文本搜索</span></span><br><span class="line">db.<span class="property">hosts</span>.<span class="title function_">find</span>(&#123;</span><br><span class="line">  <span class="string">&quot;hostname&quot;</span>: &#123; <span class="attr">$regex</span>: <span class="string">&quot;^web-.*&quot;</span>, <span class="attr">$options</span>: <span class="string">&quot;i&quot;</span> &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="聚合框架"><a href="#聚合框架" class="headerlink" title="聚合框架"></a>聚合框架</h3><ul>
<li>聚合和管道是 MongoDB 最强大、最独特的特性之一。核心概念用工厂流水线来理解：想象一下数据处理就像一条工厂装配线<ul>
<li><strong>普通查询</strong>：像是在成品仓库里<strong>筛选</strong>符合条件的产品。例如：“给我找出所有红色的汽车。” 你得到的是原始产品列表。</li>
<li><strong>聚合管道</strong>：像是把原材料送进一条<strong>多阶段的加工流水线</strong>，每个工位（阶段）都对数据进行特定处理，最终产出全新的、经过深度加工的产品。例如：原材料 → 切割 → 焊接 → 喷漆 → 组装 → 全新的汽车模型+统计报告。</li>
</ul>
</li>
<li>目的：对数据进行多阶段转换、分组、计算，生成全新的数据结构。</li>
<li>详细对比解析<ol>
<li>普通查询：检索和筛选文档。你得到的是原始数据。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：找出所有生产环境的Linux主机</span></span><br><span class="line">db.<span class="property">hosts</span>.<span class="title function_">find</span>(&#123; </span><br><span class="line">  <span class="attr">environment</span>: <span class="string">&quot;production&quot;</span>, </span><br><span class="line">  <span class="string">&quot;os.type&quot;</span>: <span class="string">&quot;Linux&quot;</span> </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回结果：原始文档数组</span></span><br><span class="line">[</span><br><span class="line">  &#123;<span class="attr">hostname</span>: <span class="string">&quot;web-01&quot;</span>, <span class="attr">environment</span>: <span class="string">&quot;production&quot;</span>, <span class="attr">os</span>: &#123;<span class="attr">type</span>: <span class="string">&quot;Linux&quot;</span>&#125;, <span class="attr">memory_gb</span>: <span class="number">16</span>, ...&#125;,</span><br><span class="line">  &#123;<span class="attr">hostname</span>: <span class="string">&quot;db-01&quot;</span>, <span class="attr">environment</span>: <span class="string">&quot;production&quot;</span>, <span class="attr">os</span>: &#123;<span class="attr">type</span>: <span class="string">&quot;Linux&quot;</span>&#125;, <span class="attr">memory_gb</span>: <span class="number">32</span>, ...&#125;,</span><br><span class="line">  <span class="comment">// ... 直接返回所有匹配的文档</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
<li>复杂查询：在检索时进行一些简单计算或逻辑处理。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：找出内存大于8G的生产环境主机，按内存降序排列，只显示主机名和内存</span></span><br><span class="line">db.<span class="property">hosts</span>.<span class="title function_">find</span>(</span><br><span class="line">  &#123; <span class="attr">environment</span>: <span class="string">&quot;production&quot;</span>, <span class="attr">memory_gb</span>: &#123; <span class="attr">$gt</span>: <span class="number">8</span> &#125; &#125;,</span><br><span class="line">  &#123; <span class="attr">hostname</span>: <span class="number">1</span>, <span class="attr">memory_gb</span>: <span class="number">1</span>, <span class="attr">_id</span>: <span class="number">0</span> &#125; <span class="comment">// 投影：选择字段</span></span><br><span class="line">).<span class="title function_">sort</span>(&#123; <span class="attr">memory_gb</span>: -<span class="number">1</span> &#125;).<span class="title function_">limit</span>(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回结果：经过筛选和排序的文档，但结构基本不变</span></span><br></pre></td></tr></table></figure></li>
<li>聚合管道 (Aggregation Pipeline) ：对数据进行<strong>多阶段转换、分组、计算，生成全新的数据结构</strong>。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目标：查询生产环境的应用，并获取其运行主机的详细信息</span></span><br><span class="line">db.<span class="property">applications</span>.<span class="title function_">aggregate</span>([ <span class="comment">// 在&#x27;applications&#x27;集合上执行聚合管道</span></span><br><span class="line">  <span class="comment">// 阶段 1: $match - 筛选文档</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$match</span>: &#123; <span class="comment">// 过滤条件：只处理符合以下条件的应用文档</span></span><br><span class="line">      <span class="string">&quot;environment&quot;</span>: <span class="string">&quot;production&quot;</span>,   <span class="comment">// 条件1: 环境为&#x27;production&#x27;</span></span><br><span class="line">      <span class="string">&quot;status&quot;</span>: <span class="string">&quot;active&quot;</span>            <span class="comment">// 条件2: 状态为&#x27;active&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 阶段 2: $lookup - 关联查询（连表查询）</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$lookup</span>: &#123; <span class="comment">// 从左集合（applications）关联到右集合（hosts）</span></span><br><span class="line">      <span class="attr">from</span>: <span class="string">&quot;hosts&quot;</span>,          <span class="comment">// 要关联的集合名称：&#x27;hosts&#x27;</span></span><br><span class="line">      <span class="attr">localField</span>: <span class="string">&quot;app_name&quot;</span>, <span class="comment">// 左集合（applications）中的关联字段：应用名称</span></span><br><span class="line">      <span class="attr">foreignField</span>: <span class="string">&quot;running_apps&quot;</span>, <span class="comment">// 右集合（hosts）中的关联字段：运行的应用列表</span></span><br><span class="line">      <span class="attr">as</span>: <span class="string">&quot;host_details&quot;</span>      <span class="comment">// 将关联匹配到的主机文档存入此新字段（是一个数组）</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 阶段 3: $unwind - 展开数组字段</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$unwind</span>: <span class="string">&quot;$host_details&quot;</span> <span class="comment">// 将`host_details`数组拆分为多条独立的文档，每条包含一个应用和一个主机</span></span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 阶段 4: $project - 重塑文档结构</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$project</span>: &#123; <span class="comment">// 定义输出文档的字段</span></span><br><span class="line">      <span class="string">&quot;_id&quot;</span>: <span class="number">0</span>,   <span class="comment">// 不显示原始的_id字段（0为排除）</span></span><br><span class="line">      <span class="string">&quot;application&quot;</span>: <span class="string">&quot;$app_name&quot;</span>,     <span class="comment">// 将app_name重命名为application</span></span><br><span class="line">      <span class="string">&quot;team&quot;</span>: <span class="string">&quot;$owner_team&quot;</span>,         <span class="comment">// 显示负责团队</span></span><br><span class="line">      <span class="string">&quot;criticality&quot;</span>: <span class="number">1</span>,               <span class="comment">// 显示应用关键程度（1为包含）</span></span><br><span class="line">      <span class="comment">// 从关联的主机文档中提取信息</span></span><br><span class="line">      <span class="string">&quot;hostname&quot;</span>: <span class="string">&quot;$host_details.hostname&quot;</span>,       <span class="comment">// 显示主机名</span></span><br><span class="line">      <span class="string">&quot;ip_address&quot;</span>: <span class="string">&quot;$host_details.ip_address&quot;</span>,   <span class="comment">// 显示IP地址</span></span><br><span class="line">      <span class="string">&quot;cpu_cores&quot;</span>: <span class="string">&quot;$host_details.specs.cpu_cores&quot;</span>, <span class="comment">// 显示CPU核心数</span></span><br><span class="line">      <span class="string">&quot;memory_gb&quot;</span>: <span class="string">&quot;$host_details.specs.memory_gb&quot;</span>, <span class="comment">// 显示内存大小</span></span><br><span class="line">      <span class="string">&quot;disk_gb&quot;</span>: <span class="string">&quot;$host_details.specs.disk_gb&quot;</span>    <span class="comment">// 显示磁盘大小</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 阶段 5: $sort - 结果排序</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$sort</span>: &#123; <span class="comment">// 排序条件</span></span><br><span class="line">      <span class="string">&quot;team&quot;</span>: <span class="number">1</span>,   <span class="comment">// 首先按团队名称升序排列 (1: 升序, -1: 降序)</span></span><br><span class="line">      <span class="string">&quot;criticality&quot;</span>: -<span class="number">1</span>, <span class="comment">// 其次按应用关键程度降序排列 (high比medium优先级高)</span></span><br><span class="line">      <span class="string">&quot;memory_gb&quot;</span>: -<span class="number">1</span>    <span class="comment">// 关键程度相同时，按主机内存降序排列</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 应用文档示例</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;_id&quot;</span>: <span class="title class_">ObjectId</span>(<span class="string">&quot;67a1b2c3d4e5f6a1b2c3d4e5&quot;</span>),</span><br><span class="line">  <span class="string">&quot;app_name&quot;</span>: <span class="string">&quot;订单服务&quot;</span>,</span><br><span class="line">  <span class="string">&quot;environment&quot;</span>: <span class="string">&quot;production&quot;</span>, <span class="comment">// 环境: production, staging, development</span></span><br><span class="line">  <span class="string">&quot;owner_team&quot;</span>: <span class="string">&quot;order-team&quot;</span>,</span><br><span class="line">  <span class="string">&quot;criticality&quot;</span>: <span class="string">&quot;high&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 主机文档示例</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;_id&quot;</span>: <span class="title class_">ObjectId</span>(<span class="string">&quot;77a1b2c3d4e5f6a1b2c3d4e5&quot;</span>),</span><br><span class="line">  <span class="string">&quot;hostname&quot;</span>: <span class="string">&quot;prod-order-01&quot;</span>,</span><br><span class="line">  <span class="string">&quot;ip_address&quot;</span>: <span class="string">&quot;192.168.1.100&quot;</span>,</span><br><span class="line">  <span class="string">&quot;environment&quot;</span>: <span class="string">&quot;production&quot;</span>,</span><br><span class="line">  <span class="string">&quot;specs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;cpu_cores&quot;</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="string">&quot;memory_gb&quot;</span>: <span class="number">32</span>,</span><br><span class="line">    <span class="string">&quot;disk_gb&quot;</span>: <span class="number">500</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;running_apps&quot;</span>: [<span class="string">&quot;订单服务&quot;</span>, <span class="string">&quot;用户服务&quot;</span>] <span class="comment">// 在此主机上运行的应用名称数组</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 返回结果：完全重新组织的数据</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;application&quot;</span>: <span class="string">&quot;订单服务&quot;</span>,</span><br><span class="line">    <span class="string">&quot;team&quot;</span>: <span class="string">&quot;order-team&quot;</span>,</span><br><span class="line">    <span class="string">&quot;criticality&quot;</span>: <span class="string">&quot;high&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hostname&quot;</span>: <span class="string">&quot;prod-order-01&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ip_address&quot;</span>: <span class="string">&quot;192.168.1.100&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cpu_cores&quot;</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="string">&quot;memory_gb&quot;</span>: <span class="number">32</span>,</span><br><span class="line">    <span class="string">&quot;disk_gb&quot;</span>: <span class="number">500</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;application&quot;</span>: <span class="string">&quot;支付网关&quot;</span>, </span><br><span class="line">    <span class="string">&quot;team&quot;</span>: <span class="string">&quot;payment-team&quot;</span>,</span><br><span class="line">    <span class="string">&quot;criticality&quot;</span>: <span class="string">&quot;critical&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hostname&quot;</span>: <span class="string">&quot;prod-payment-01&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ip_address&quot;</span>: <span class="string">&quot;192.168.1.101&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cpu_cores&quot;</span>: <span class="number">16</span>,</span><br><span class="line">    <span class="string">&quot;memory_gb&quot;</span>: <span class="number">64</span>,</span><br><span class="line">    <span class="string">&quot;disk_gb&quot;</span>: <span class="number">1000</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ... 其他结果</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
<li>CMDB 应用场景<br>问题1：”显示每个团队负责的主机数量，并按环境分别统计”<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">hosts</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  &#123; <span class="attr">$match</span>: &#123; <span class="attr">status</span>: <span class="string">&quot;running&quot;</span> &#125; &#125;,</span><br><span class="line">  &#123; <span class="attr">$group</span>: &#123;</span><br><span class="line">    <span class="attr">_id</span>: &#123; <span class="attr">team</span>: <span class="string">&quot;$owner_team&quot;</span>, <span class="attr">env</span>: <span class="string">&quot;$environment&quot;</span> &#125;,</span><br><span class="line">    <span class="attr">host_count</span>: &#123; <span class="attr">$sum</span>: <span class="number">1</span> &#125;</span><br><span class="line">  &#125;&#125;,</span><br><span class="line">  &#123; <span class="attr">$sort</span>: &#123; <span class="attr">host_count</span>: -<span class="number">1</span> &#125; &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
问题2：”找出生产环境中，哪些应用依赖的主机平均内存使用率超过80%”<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">applications</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  &#123; <span class="attr">$match</span>: &#123; <span class="attr">environment</span>: <span class="string">&quot;production&quot;</span> &#125; &#125;,</span><br><span class="line">  &#123; <span class="attr">$lookup</span>: &#123;</span><br><span class="line">    <span class="attr">from</span>: <span class="string">&quot;hosts&quot;</span>,</span><br><span class="line">    <span class="attr">localField</span>: <span class="string">&quot;dependent_hosts&quot;</span>, </span><br><span class="line">    <span class="attr">foreignField</span>: <span class="string">&quot;hostname&quot;</span>,</span><br><span class="line">    <span class="attr">as</span>: <span class="string">&quot;host_details&quot;</span></span><br><span class="line">  &#125;&#125;,</span><br><span class="line">  &#123; <span class="attr">$project</span>: &#123;</span><br><span class="line">    <span class="attr">app_name</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">avg_memory_usage</span>: &#123; <span class="attr">$avg</span>: <span class="string">&quot;$host_details.memory_usage_percent&quot;</span> &#125;</span><br><span class="line">  &#125;&#125;,</span><br><span class="line">  &#123; <span class="attr">$match</span>: &#123; <span class="attr">avg_memory_usage</span>: &#123; <span class="attr">$gt</span>: <span class="number">80</span> &#125; &#125; &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
<h3 id="索引策略"><a href="#索引策略" class="headerlink" title="索引策略"></a>索引策略</h3><ol>
<li>索引类型与应用场景：</li>
</ol>
<ul>
<li>单字段索引：<code>db.hosts.createIndex(&#123; hostname: 1 &#125;)</code></li>
<li>复合索引：<code>db.hosts.createIndex(&#123; environment: 1, status: 1 &#125;)</code>  </li>
<li>多键索引：数组字段索引 <code>db.hosts.createIndex(&#123; tags: 1 &#125;)</code></li>
<li>文本索引：全文搜索 <code>db.hosts.createIndex(&#123; description: &quot;text&quot; &#125;)</code></li>
<li>TTL索引：自动过期数据 <code>db.logs.createIndex(&#123; createdAt: 1 &#125;, &#123; expireAfterSeconds: 3600 &#125;)</code></li>
</ul>
<ol start="2">
<li>索引优化原则：</li>
</ol>
<ul>
<li>ESR规则：Equality(等值) → Sort(排序) → Range(范围)</li>
<li>覆盖查询：索引包含所有查询字段，避免回表</li>
<li>索引交集：MongoDB可自动组合多个索引</li>
</ul>
<h3 id="高可用与扩展"><a href="#高可用与扩展" class="headerlink" title="高可用与扩展"></a>高可用与扩展</h3><h4 id="1-复制集（Replica-Set）深度"><a href="#1-复制集（Replica-Set）深度" class="headerlink" title="1. 复制集（Replica Set）深度"></a>1. 复制集（Replica Set）深度</h4><ul>
<li><strong>架构组成</strong>：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Primary（主节点）← 读写操作</span><br><span class="line">    ↓ 数据同步</span><br><span class="line">Secondary-1（从节点）← 只读查询</span><br><span class="line">Secondary-2（从节点）← 只读查询</span><br><span class="line">Arbiter（仲裁节点）← 仅参与选举</span><br></pre></td></tr></table></figure></li>
<li><strong>配置示例</strong>：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复制集配置</span></span><br><span class="line">cfg = &#123;</span><br><span class="line">  <span class="attr">_id</span>: <span class="string">&quot;cmdb-rs&quot;</span>,</span><br><span class="line">  <span class="attr">members</span>: [</span><br><span class="line">    &#123;<span class="attr">_id</span>: <span class="number">0</span>, <span class="attr">host</span>: <span class="string">&quot;mongo1:27017&quot;</span>, <span class="attr">priority</span>: <span class="number">2</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">host</span>: <span class="string">&quot;mongo2:27017&quot;</span>, <span class="attr">priority</span>: <span class="number">1</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">_id</span>: <span class="number">2</span>, <span class="attr">host</span>: <span class="string">&quot;mongo3:27017&quot;</span>, <span class="attr">priority</span>: <span class="number">1</span>, <span class="attr">arbiterOnly</span>: <span class="literal">true</span>&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">rs.<span class="title function_">initiate</span>(cfg)</span><br></pre></td></tr></table></figure></li>
<li><strong>读写关注</strong>：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 强一致性写操作</span></span><br><span class="line">db.<span class="property">hosts</span>.<span class="title function_">insertOne</span>(doc, &#123;</span><br><span class="line">  <span class="attr">writeConcern</span>: &#123; <span class="attr">w</span>: <span class="string">&quot;majority&quot;</span>, <span class="attr">wtimeout</span>: <span class="number">5000</span> &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从节点读取（最终一致性）</span></span><br><span class="line">db.<span class="property">hosts</span>.<span class="title function_">find</span>().<span class="title function_">readPref</span>(<span class="string">&quot;secondary&quot;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-分片集群（Sharded-Cluster）"><a href="#2-分片集群（Sharded-Cluster）" class="headerlink" title="2. 分片集群（Sharded Cluster）"></a>2. 分片集群（Sharded Cluster）</h4><ul>
<li><strong>分片策略选择</strong>：<ul>
<li><strong>基于范围分片</strong>：适合范围查询，可能产生热点</li>
<li><strong>基于哈希分片</strong>：数据分布均匀，范围查询效率低</li>
<li><strong>区域分片</strong>：基于标签的智能数据分布</li>
</ul>
</li>
<li><strong>分片键选择考量</strong>：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 好的分片键：基数高、分布均匀</span></span><br><span class="line">sh.<span class="title function_">shardCollection</span>(<span class="string">&quot;cmdb.hosts&quot;</span>, &#123; <span class="string">&quot;tenant_id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;hostname&quot;</span>: <span class="number">1</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 避免的选择：低基数、单调递增</span></span><br><span class="line"><span class="comment">// sh.shardCollection(&quot;cmdb.hosts&quot;, &#123; &quot;created_date&quot;: 1 &#125;) // 不好！</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="CMDB助手查询工具设计（基于MCP）"><a href="#CMDB助手查询工具设计（基于MCP）" class="headerlink" title="CMDB助手查询工具设计（基于MCP）"></a>CMDB助手查询工具设计（基于MCP）</h3><ul>
<li>MCP工具架构设计<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">自然语言查询 → MCP Server → 查询解析器 → MongoDB查询生成器 → 结果格式化</span><br></pre></td></tr></table></figure></li>
<li><strong>MCP Server 核心代码</strong>：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mcp <span class="keyword">import</span> MCPServer, Context</span><br><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Any</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CMDBAgentMcpServer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, mongo_uri: <span class="built_in">str</span></span>):</span><br><span class="line">        self.client = pymongo.MongoClient(mongo_uri)</span><br><span class="line">        self.db = self.client.cmdb</span><br><span class="line">        self.setup_tools()</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @mcp_tool(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">        name=<span class="string">&quot;query_hosts&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">        description=<span class="string">&quot;根据条件查询主机信息&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">        args_schema=&#123;</span></span></span><br><span class="line"><span class="params"><span class="meta">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">            <span class="string">&quot;properties&quot;</span>: &#123;</span></span></span><br><span class="line"><span class="params"><span class="meta">                <span class="string">&quot;environment&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>, <span class="string">&quot;enum&quot;</span>: [<span class="string">&quot;production&quot;</span>, <span class="string">&quot;staging&quot;</span>, <span class="string">&quot;development&quot;</span>]&#125;,</span></span></span><br><span class="line"><span class="params"><span class="meta">                <span class="string">&quot;os_type&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>&#125;,</span></span></span><br><span class="line"><span class="params"><span class="meta">                <span class="string">&quot;min_memory&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span>&#125;,</span></span></span><br><span class="line"><span class="params"><span class="meta">                <span class="string">&quot;status&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>, <span class="string">&quot;enum&quot;</span>: [<span class="string">&quot;running&quot;</span>, <span class="string">&quot;stopped&quot;</span>, <span class="string">&quot;maintenance&quot;</span>]&#125;,</span></span></span><br><span class="line"><span class="params"><span class="meta">                <span class="string">&quot;tags&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;array&quot;</span>, <span class="string">&quot;items&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>&#125;&#125;,</span></span></span><br><span class="line"><span class="params"><span class="meta">                <span class="string">&quot;limit&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span>, <span class="string">&quot;default&quot;</span>: <span class="number">10</span>&#125;</span></span></span><br><span class="line"><span class="params"><span class="meta">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="meta">        &#125;</span></span></span><br><span class="line"><span class="params"><span class="meta">    </span>)</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">query_hosts</span>(<span class="params">self, ctx: Context, **filters</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;智能主机查询工具&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 构建MongoDB查询</span></span><br><span class="line">        query = self._build_host_query(filters)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 执行查询</span></span><br><span class="line">        cursor = self.db.hosts.find(query[<span class="string">&quot;filter&quot;</span>], query[<span class="string">&quot;projection&quot;</span>])</span><br><span class="line">        cursor = cursor.sort(query[<span class="string">&quot;sort&quot;</span>]).limit(query[<span class="string">&quot;limit&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        results = <span class="built_in">list</span>(cursor)</span><br><span class="line">        <span class="keyword">return</span> self._format_host_results(results)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_build_host_query</span>(<span class="params">self, filters: <span class="type">Dict</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;将自然语言参数转换为MongoDB查询&quot;&quot;&quot;</span></span><br><span class="line">        query_filter = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 环境过滤</span></span><br><span class="line">        <span class="keyword">if</span> filters.get(<span class="string">&quot;environment&quot;</span>):</span><br><span class="line">            query_filter[<span class="string">&quot;environment&quot;</span>] = filters[<span class="string">&quot;environment&quot;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 操作系统过滤（支持模糊匹配）</span></span><br><span class="line">        <span class="keyword">if</span> filters.get(<span class="string">&quot;os_type&quot;</span>):</span><br><span class="line">            query_filter[<span class="string">&quot;os.type&quot;</span>] = &#123;<span class="string">&quot;$regex&quot;</span>: filters[<span class="string">&quot;os_type&quot;</span>], <span class="string">&quot;$options&quot;</span>: <span class="string">&quot;i&quot;</span>&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 内存条件</span></span><br><span class="line">        <span class="keyword">if</span> filters.get(<span class="string">&quot;min_memory&quot;</span>):</span><br><span class="line">            query_filter[<span class="string">&quot;specs.memory_gb&quot;</span>] = &#123;<span class="string">&quot;$gte&quot;</span>: filters[<span class="string">&quot;min_memory&quot;</span>]&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 状态过滤</span></span><br><span class="line">        <span class="keyword">if</span> filters.get(<span class="string">&quot;status&quot;</span>):</span><br><span class="line">            query_filter[<span class="string">&quot;status&quot;</span>] = filters[<span class="string">&quot;status&quot;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 标签查询</span></span><br><span class="line">        <span class="keyword">if</span> filters.get(<span class="string">&quot;tags&quot;</span>):</span><br><span class="line">            query_filter[<span class="string">&quot;tags&quot;</span>] = &#123;<span class="string">&quot;$all&quot;</span>: filters[<span class="string">&quot;tags&quot;</span>]&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;filter&quot;</span>: query_filter,</span><br><span class="line">            <span class="string">&quot;projection&quot;</span>: &#123;<span class="string">&quot;_id&quot;</span>: <span class="number">0</span>, <span class="string">&quot;hostname&quot;</span>: <span class="number">1</span>, <span class="string">&quot;ip&quot;</span>: <span class="number">1</span>, <span class="string">&quot;environment&quot;</span>: <span class="number">1</span>, <span class="string">&quot;os&quot;</span>: <span class="number">1</span>, <span class="string">&quot;specs&quot;</span>: <span class="number">1</span>&#125;,</span><br><span class="line">            <span class="string">&quot;sort&quot;</span>: [(<span class="string">&quot;last_seen&quot;</span>, -<span class="number">1</span>)],</span><br><span class="line">            <span class="string">&quot;limit&quot;</span>: filters.get(<span class="string">&quot;limit&quot;</span>, <span class="number">10</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @mcp_tool(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">        name=<span class="string">&quot;analyze_infrastructure&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">        description=<span class="string">&quot;基础设施统计分析&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">        args_schema=&#123;</span></span></span><br><span class="line"><span class="params"><span class="meta">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>, </span></span></span><br><span class="line"><span class="params"><span class="meta">            <span class="string">&quot;properties&quot;</span>: &#123;</span></span></span><br><span class="line"><span class="params"><span class="meta">                <span class="string">&quot;analysis_type&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>, <span class="string">&quot;enum&quot;</span>: [<span class="string">&quot;environment&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;team&quot;</span>]&#125;,</span></span></span><br><span class="line"><span class="params"><span class="meta">                <span class="string">&quot;metric&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>, <span class="string">&quot;enum&quot;</span>: [<span class="string">&quot;count&quot;</span>, <span class="string">&quot;memory&quot;</span>, <span class="string">&quot;cpu&quot;</span>]&#125;</span></span></span><br><span class="line"><span class="params"><span class="meta">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="meta">        &#125;</span></span></span><br><span class="line"><span class="params"><span class="meta">    </span>)</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">analyze_infrastructure</span>(<span class="params">self, ctx: Context, analysis_type: <span class="built_in">str</span>, metric: <span class="built_in">str</span> = <span class="string">&quot;count&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;聚合分析工具&quot;&quot;&quot;</span></span><br><span class="line">        pipeline = self._build_analysis_pipeline(analysis_type, metric)</span><br><span class="line">        results = <span class="built_in">list</span>(self.db.hosts.aggregate(pipeline))</span><br><span class="line">        <span class="keyword">return</span> self._format_analysis_results(results, analysis_type, metric)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">server = CMDBAgentMcpServer(<span class="string">&quot;mongodb://localhost:27017/cmdb&quot;</span>)</span><br></pre></td></tr></table></figure></li>
<li><strong>Agent提示词设计</strong>：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">你是一个CMDB专家，可以查询和分析基础设施信息。</span><br><span class="line"></span><br><span class="line">可用工具：</span><br><span class="line">1. query_hosts - 查询主机信息，支持按环境、操作系统、内存等条件过滤</span><br><span class="line">2. analyze_infrastructure - 统计分析基础设施资源分布</span><br><span class="line"></span><br><span class="line">示例交互：</span><br><span class="line">用户：列出生产环境中所有运行CentOS的主机</span><br><span class="line">AI：我将使用query_hosts工具查询...</span><br><span class="line">工具调用：query_hosts(environment=&quot;production&quot;, os_type=&quot;CentOS&quot;)</span><br><span class="line"></span><br><span class="line">用户：按环境统计主机数量  </span><br><span class="line">AI：使用analyze_infrastructure进行分析...</span><br><span class="line">工具调用：analyze_infrastructure(analysis_type=&quot;environment&quot;, metric=&quot;count&quot;)</span><br></pre></td></tr></table></figure></li>
<li>高级查询特性支持<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 支持复杂查询的扩展工具</span></span><br><span class="line"><span class="meta">@mcp_tool(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">    name=<span class="string">&quot;advanced_host_search&quot;</span>, </span></span></span><br><span class="line"><span class="params"><span class="meta">    description=<span class="string">&quot;高级主机搜索，支持复杂条件组合&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">advanced_search</span>(<span class="params">self, ctx: Context, search_expression: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;支持自然语言复杂查询&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 使用LLM解析复杂查询条件</span></span><br><span class="line">    parsed_query = <span class="keyword">await</span> self.llm_parse_search(search_expression)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> self.execute_advanced_query(parsed_query)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关系查询工具</span></span><br><span class="line"><span class="meta">@mcp_tool(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">    name=<span class="string">&quot;find_related_assets&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">    description=<span class="string">&quot;查找相关资产和依赖关系&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">find_related_assets</span>(<span class="params">self, ctx: Context, hostname: <span class="built_in">str</span>, relation_type: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;查询资产关系&quot;&quot;&quot;</span></span><br><span class="line">    pipeline = [</span><br><span class="line">        &#123;<span class="string">&quot;$match&quot;</span>: &#123;<span class="string">&quot;hostname&quot;</span>: hostname&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;$graphLookup&quot;</span>: &#123;  <span class="comment"># 使用图查询查找关系</span></span><br><span class="line">            <span class="string">&quot;from&quot;</span>: <span class="string">&quot;asset_relations&quot;</span>,</span><br><span class="line">            <span class="string">&quot;startWith&quot;</span>: <span class="string">&quot;$_id&quot;</span>, </span><br><span class="line">            <span class="string">&quot;connectFromField&quot;</span>: <span class="string">&quot;from_asset&quot;</span>,</span><br><span class="line">            <span class="string">&quot;connectToField&quot;</span>: <span class="string">&quot;to_asset&quot;</span>, </span><br><span class="line">            <span class="string">&quot;as&quot;</span>: <span class="string">&quot;relationships&quot;</span></span><br><span class="line">        &#125;&#125;</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">list</span>(self.db.hosts.aggregate(pipeline))</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/12/08/MongoDB/" data-id="cmjzvj9ma000dhgv51mh07ezb" data-title="MongoDB" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/12/22/Agent/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Agent
        
      </div>
    </a>
  
  
    <a href="/2024/10/22/Docker_Kubernetes/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Kubernetes</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2046/12/">December 2046</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2046/08/">August 2046</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2026/01/">January 2026</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/12/">December 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">October 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2046/12/30/nice-photo/">Nice Photo</a>
          </li>
        
          <li>
            <a href="/2046/08/27/Guitar/">Guitar 🎸</a>
          </li>
        
          <li>
            <a href="/2026/01/10/Milvus/">Milvus</a>
          </li>
        
          <li>
            <a href="/2025/12/22/Agent/">Agent</a>
          </li>
        
          <li>
            <a href="/2025/12/08/MongoDB/">MongoDB</a>
          </li>
        
          <li>
            <a href="/2024/10/22/Docker_Kubernetes/">Kubernetes</a>
          </li>
        
          <li>
            <a href="/2024/09/22/InfluxDB/">InfluxDB</a>
          </li>
        
          <li>
            <a href="/2024/09/22/Golang/">Golang</a>
          </li>
        
          <li>
            <a href="/2024/08/18/%E7%90%86%E8%B4%A2/">Lic Ai</a>
          </li>
        
          <li>
            <a href="/2024/07/07/%E7%BE%8E%E7%9A%84Midea/">美 的 Midea</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2026 fengcai<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>